<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#c72825',
                        secondary: '#f0bc73',
                        accent: '#e17055',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .tab-active {
            border-bottom: 3px solid #c72825;
            color: #c72825;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-primary">üç± Rice Katsu Admin</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-gray-700">Halo, <strong><%= user.email %></strong></span>
                    <a href="/" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-accent transition">
                        Ke Website
                    </a>
                    <a href="/logout" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="bg-white rounded-lg shadow-sm">
            <div class="flex border-b">
                <button onclick="switchTab('orders')" id="tab-orders" class="tab-active px-6 py-4 font-semibold text-lg focus:outline-none transition">
                    üì¶ Pesanan
                </button>
                <button onclick="switchTab('products')" id="tab-products" class="px-6 py-4 font-semibold text-lg text-gray-600 hover:text-primary focus:outline-none transition">
                    üçú Produk
                </button>
                <button onclick="switchTab('reports')" id="tab-reports" class="px-6 py-4 font-semibold text-lg text-gray-600 hover:text-primary focus:outline-none transition">
                    üìä Laporan
                </button>
            </div>

            <!-- Orders Tab -->
            <div id="content-orders" class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Daftar Pesanan</h2>
                    <button onclick="loadOrders()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-red-700 transition">
                        üîÑ Refresh
                    </button>
                </div>
                
                <!-- Filter Section -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">üîç Filter Berdasarkan Tanggal</h3>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                            <input type="date" id="order-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                            <input type="date" id="order-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <button onclick="filterOrders()" class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-accent transition font-semibold">
                            Terapkan Filter
                        </button>
                        <button onclick="resetOrderFilter()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Reset
                        </button>
                    </div>
                </div>
                
                <div id="orders-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    <p class="mt-4 text-gray-600">Memuat pesanan...</p>
                </div>
                
                <div id="orders-list" class="hidden">
                    <!-- Orders will be loaded here -->
                </div>
            </div>

            <!-- Products Tab -->
            <div id="content-products" class="p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Manajemen Produk</h2>
                    <button onclick="showAddProductModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-red-700 transition">
                        ‚ûï Tambah Produk
                    </button>
                </div>
                
                <div id="products-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    <p class="mt-4 text-gray-600">Memuat produk...</p>
                </div>
                
                <div id="products-list" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="content-reports" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Laporan Penjualan & Keuntungan</h2>
                
                <!-- Filter Section -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">Filter Periode</h3>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Periode</label>
                            <select id="report-period" onchange="toggleCustomDateInputs()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="day">Per Hari</option>
                                <option value="week">Per Minggu</option>
                                <option value="month">Per Bulan</option>
                                <option value="year">Per Tahun</option>
                                <option value="custom">Kustom</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]" id="report-start-date-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                            <input type="date" id="report-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="flex-1 min-w-[200px]" id="report-end-date-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                            <input type="date" id="report-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <button onclick="loadReports()" class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-accent transition font-semibold">
                            Tampilkan Laporan
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="report-summary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm opacity-90">Total Pesanan</span>
                            <span class="text-2xl">üì¶</span>
                        </div>
                        <p id="summary-total-orders" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm opacity-90">Total Pendapatan</span>
                            <span class="text-2xl">üí∞</span>
                        </div>
                        <p id="summary-total-revenue" class="text-2xl font-bold">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm opacity-90">Rata-rata Nilai Order</span>
                            <span class="text-2xl">üìä</span>
                        </div>
                        <p id="summary-avg-order" class="text-2xl font-bold">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-lg p-5 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm opacity-90">Total Periode</span>
                            <span class="text-2xl">üìÖ</span>
                        </div>
                        <p id="summary-periods" class="text-3xl font-bold">0</p>
                    </div>
                </div>

                <!-- Sales Chart -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6 hidden" id="sales-chart-container">
                    <h3 class="font-bold text-gray-800 mb-4 text-xl">Grafik Penjualan</h3>
                    <div id="sales-chart" class="overflow-x-auto">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>

                <!-- Sales Table -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6 hidden" id="sales-table-container">
                    <h3 class="font-bold text-gray-800 mb-4 text-xl">Detail Penjualan per Periode</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b-2 border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Periode</th>
                                    <th class="px-4 py-3 text-right font-semibold text-gray-700">Jumlah Pesanan</th>
                                    <th class="px-4 py-3 text-right font-semibold text-gray-700">Total Pendapatan</th>
                                    <th class="px-4 py-3 text-right font-semibold text-gray-700">Rata-rata Order</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body">
                                <!-- Table rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 hidden" id="top-products-container">
                    <h3 class="font-bold text-gray-800 mb-4 text-xl">üèÜ Produk Terlaris</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b-2 border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Ranking</th>
                                    <th class="px-4 py-3 text-left font-semibold text-gray-700">Nama Produk</th>
                                    <th class="px-4 py-3 text-right font-semibold text-gray-700">Jumlah Terjual</th>
                                    <th class="px-4 py-3 text-right font-semibold text-gray-700">Total Pendapatan</th>
                                    <th class="px-4 py-3 text-right font-semibold text-gray-700">Jumlah Order</th>
                                </tr>
                            </thead>
                            <tbody id="top-products-body">
                                <!-- Table rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="reports-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    <p class="mt-4 text-gray-600">Memuat laporan...</p>
                </div>

                <div id="reports-empty" class="text-center py-12 text-gray-500">
                    Pilih periode dan klik "Tampilkan Laporan" untuk melihat data
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Order Detail -->
    <div id="modal-order-detail" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-primary">Detail Pesanan</h3>
                <button onclick="closeOrderDetailModal()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>
            <div id="order-detail-content" class="p-6">
                <!-- Order detail will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal Add/Edit Product -->
    <div id="modal-product" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h3 id="product-modal-title" class="text-xl font-bold text-primary">Tambah Produk</h3>
                <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <input type="hidden" id="product-id" value="">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Produk</label>
                    <input type="text" id="product-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Harga</label>
                    <input type="number" id="product-price" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="product-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-red-700 transition font-semibold">
                        Simpan
                    </button>
                    <button type="button" onclick="closeProductModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentTab = 'orders';
        
        // Switch Tab
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.getElementById('tab-orders').classList.remove('tab-active', 'text-primary');
            document.getElementById('tab-products').classList.remove('tab-active', 'text-primary');
            document.getElementById('tab-reports').classList.remove('tab-active', 'text-primary');
            document.getElementById('tab-orders').classList.add('text-gray-600');
            document.getElementById('tab-products').classList.add('text-gray-600');
            document.getElementById('tab-reports').classList.add('text-gray-600');
            
            document.getElementById(`tab-${tab}`).classList.add('tab-active', 'text-primary');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-600');
            
            // Show/hide content
            document.getElementById('content-orders').classList.add('hidden');
            document.getElementById('content-products').classList.add('hidden');
            document.getElementById('content-reports').classList.add('hidden');
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            // Load data
            if (tab === 'orders') {
                loadOrders();
            } else if (tab === 'products') {
                loadProducts();
            } else if (tab === 'reports') {
                // Reports loaded on demand
            }
        }
        
        // Load Orders with optional date filter
        async function loadOrders(startDate = null, endDate = null) {
            document.getElementById('orders-loading').classList.remove('hidden');
            document.getElementById('orders-list').classList.add('hidden');
            
            try {
                let url = '/api/admin/orders';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderOrders(data.orders);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                alert('Gagal memuat pesanan!');
            }
        }
        
        function filterOrders() {
            const startDate = document.getElementById('order-start-date').value;
            const endDate = document.getElementById('order-end-date').value;
            loadOrders(startDate, endDate);
        }
        
        function resetOrderFilter() {
            document.getElementById('order-start-date').value = '';
            document.getElementById('order-end-date').value = '';
            loadOrders();
        }
        
        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Belum ada pesanan</p>';
            } else {
                container.innerHTML = orders.map(order => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold text-gray-800">Order #${order.id}</h3>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusBadgeClass(order.status)}">
                                        ${order.status}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600">Email: ${order.user_email || 'Guest'}</p>
                                <p class="text-sm text-gray-600">Tanggal: ${new Date(order.tanggal).toLocaleString('id-ID')}</p>
                                <p class="text-lg font-bold text-primary mt-2">Total: Rp ${order.total.toLocaleString('id-ID')}</p>
                            </div>
                            <button onclick="showOrderDetail(${order.id})" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-accent transition">
                                Lihat Detail
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('orders-loading').classList.add('hidden');
            container.classList.remove('hidden');
        }
        
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'processing': return 'bg-blue-100 text-blue-800';
                case 'completed': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Show Order Detail
        async function showOrderDetail(orderId) {
            document.getElementById('modal-order-detail').classList.remove('hidden');
            document.getElementById('order-detail-content').innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>';
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`);
                const data = await response.json();
                
                if (data.success) {
                    renderOrderDetail(data.order, data.items);
                }
            } catch (error) {
                console.error('Error loading order detail:', error);
                alert('Gagal memuat detail pesanan!');
            }
        }
        
        function renderOrderDetail(order, items) {
            const content = `
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-800 mb-3">Informasi Pesanan</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-gray-600">Order ID:</span> <strong>#${order.id}</strong></div>
                            <div><span class="text-gray-600">Status:</span> <strong class="text-primary">${order.status}</strong></div>
                            <div><span class="text-gray-600">Tanggal:</span> ${new Date(order.tanggal).toLocaleString('id-ID')}</div>
                            <div><span class="text-gray-600">Total:</span> <strong class="text-lg text-primary">Rp ${order.total.toLocaleString('id-ID')}</strong></div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-800 mb-3">Informasi Pembeli</h4>
                        <div class="text-sm space-y-1">
                            <p><span class="text-gray-600">Email:</span> <strong>${order.user_email || '-'}</strong></p>
                            <p><span class="text-gray-600">Alamat:</span> ${order.user_address || '-'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-gray-800 mb-3">Produk yang Dipesan</h4>
                        <div class="space-y-3">
                            ${items.map(item => `
                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h5 class="font-semibold text-gray-800">${item.nama_produk}</h5>
                                            <p class="text-sm text-gray-600">Harga: Rp ${item.harga_produk.toLocaleString('id-ID')}</p>
                                            <p class="text-sm text-gray-600">Jumlah: ${item.jumlah_produk}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-primary">Rp ${item.total.toLocaleString('id-ID')}</p>
                                            <span class="text-xs px-2 py-1 rounded-full ${getStatusBadgeClass(item.status_produk)}">${item.status_produk}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <label class="block font-bold text-gray-800 mb-3">Update Status Pesanan</label>
                        <div class="flex gap-3">
                            <select id="order-status-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button onclick="updateOrderStatus(${order.id})" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-red-700 transition font-semibold">
                                Update
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('order-detail-content').innerHTML = content;
        }
        
        function closeOrderDetailModal() {
            document.getElementById('modal-order-detail').classList.add('hidden');
        }
        
        async function updateOrderStatus(orderId) {
            const status = document.getElementById('order-status-select').value;
            
            try {
                const response = await fetch(`/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Status berhasil diupdate!');
                    closeOrderDetailModal();
                    loadOrders();
                } else {
                    alert(data.message || 'Gagal update status!');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Gagal update status!');
            }
        }
        
        // Load Products
        async function loadProducts() {
            document.getElementById('products-loading').classList.remove('hidden');
            document.getElementById('products-list').classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/products');
                const data = await response.json();
                
                if (data.success) {
                    renderProducts(data.products);
                }
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Gagal memuat produk!');
            }
        }
        
        function renderProducts(products) {
            const container = document.getElementById('products-list');
            
            if (products.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">Belum ada produk</p>';
            } else {
                container.innerHTML = products.map(product => `
                    <div class="bg-white border border-gray-200 rounded-lg p-5 hover:shadow-lg transition">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${product.name}</h3>
                        <p class="text-2xl font-bold text-primary mb-3">Rp ${product.price.toLocaleString('id-ID')}</p>
                        <p class="text-sm text-gray-600 mb-4">${product.description || 'Tidak ada deskripsi'}</p>
                        <div class="flex gap-2">
                            <button onclick="editProduct(${product.id}, '${product.name}', ${product.price}, '${product.description || ''}')" class="flex-1 px-3 py-2 bg-secondary text-white rounded-lg hover:bg-accent transition text-sm font-semibold">
                                Edit
                            </button>
                            <button onclick="deleteProduct(${product.id}, '${product.name}')" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-semibold">
                                Hapus
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('products-loading').classList.add('hidden');
            container.classList.remove('hidden');
        }
        
        function showAddProductModal() {
            document.getElementById('product-modal-title').textContent = 'Tambah Produk';
            document.getElementById('product-id').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-description').value = '';
            document.getElementById('modal-product').classList.remove('hidden');
        }
        
        function editProduct(id, name, price, description) {
            document.getElementById('product-modal-title').textContent = 'Edit Produk';
            document.getElementById('product-id').value = id;
            document.getElementById('product-name').value = name;
            document.getElementById('product-price').value = price;
            document.getElementById('product-description').value = description;
            document.getElementById('modal-product').classList.remove('hidden');
        }
        
        function closeProductModal() {
            document.getElementById('modal-product').classList.add('hidden');
        }
        
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const description = document.getElementById('product-description').value;
            
            const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
            const method = id ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    closeProductModal();
                    loadProducts();
                } else {
                    alert(data.message || 'Gagal menyimpan produk!');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Gagal menyimpan produk!');
            }
        });
        
        async function deleteProduct(id, name) {
            if (!confirm(`Yakin ingin menghapus produk "${name}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/products/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadProducts();
                } else {
                    alert(data.message || 'Gagal menghapus produk!');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Gagal menghapus produk!');
            }
        }
        
        // Reports Functions
        function toggleCustomDateInputs() {
            const period = document.getElementById('report-period').value;
            const startContainer = document.getElementById('report-start-date-container');
            const endContainer = document.getElementById('report-end-date-container');
            
            if (period === 'custom') {
                startContainer.classList.remove('hidden');
                endContainer.classList.remove('hidden');
            } else {
                startContainer.classList.add('hidden');
                endContainer.classList.add('hidden');
            }
        }
        
        async function loadReports() {
            const period = document.getElementById('report-period').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            // Hide empty state, show loading
            document.getElementById('reports-empty').classList.add('hidden');
            document.getElementById('reports-loading').classList.remove('hidden');
            document.getElementById('report-summary').classList.add('hidden');
            document.getElementById('sales-chart-container').classList.add('hidden');
            document.getElementById('sales-table-container').classList.add('hidden');
            document.getElementById('top-products-container').classList.add('hidden');
            
            try {
                // Build query params
                const params = new URLSearchParams({ period });
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                // Load sales report
                const salesResponse = await fetch(`/api/admin/reports/sales?${params.toString()}`);
                const salesData = await salesResponse.json();
                
                // Load top products
                const productsParams = new URLSearchParams();
                if (startDate) productsParams.append('startDate', startDate);
                if (endDate) productsParams.append('endDate', endDate);
                const productsResponse = await fetch(`/api/admin/reports/top-products?${productsParams.toString()}`);
                const productsData = await productsResponse.json();
                
                if (salesData.success) {
                    renderSalesReport(salesData.reports, salesData.summary, period);
                }
                
                if (productsData.success) {
                    renderTopProducts(productsData.products);
                }
                
                document.getElementById('reports-loading').classList.add('hidden');
            } catch (error) {
                console.error('Error loading reports:', error);
                alert('Gagal memuat laporan!');
                document.getElementById('reports-loading').classList.add('hidden');
                document.getElementById('reports-empty').classList.remove('hidden');
            }
        }
        
        function renderSalesReport(reports, summary, period) {
            // Show summary cards
            document.getElementById('report-summary').classList.remove('hidden');
            document.getElementById('summary-total-orders').textContent = summary.totalOrders.toLocaleString('id-ID');
            document.getElementById('summary-total-revenue').textContent = 'Rp ' + summary.totalRevenue.toLocaleString('id-ID');
            document.getElementById('summary-avg-order').textContent = 'Rp ' + Math.round(summary.avgOrderValue).toLocaleString('id-ID');
            document.getElementById('summary-periods').textContent = reports.length.toLocaleString('id-ID');
            
            // Render table
            if (reports.length > 0) {
                document.getElementById('sales-table-container').classList.remove('hidden');
                const tableBody = document.getElementById('sales-table-body');
                tableBody.innerHTML = reports.map((row, index) => {
                    let periodLabel = row.period;
                    if (period === 'week') {
                        periodLabel = `Minggu ${row.period}`;
                    } else if (period === 'month') {
                        periodLabel = formatMonth(row.period);
                    } else if (period === 'year') {
                        periodLabel = `Tahun ${row.period}`;
                    } else {
                        periodLabel = formatDate(row.period);
                    }
                    
                    return `
                        <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <td class="px-4 py-3 text-left">${periodLabel}</td>
                            <td class="px-4 py-3 text-right font-semibold">${row.total_orders}</td>
                            <td class="px-4 py-3 text-right font-semibold text-green-600">Rp ${parseFloat(row.total_revenue).toLocaleString('id-ID')}</td>
                            <td class="px-4 py-3 text-right">Rp ${parseFloat(row.avg_order_value).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                }).join('');
                
                // Render simple bar chart
                document.getElementById('sales-chart-container').classList.remove('hidden');
                renderSimpleChart(reports, period);
            }
        }
        
        function renderSimpleChart(reports, period) {
            const maxRevenue = Math.max(...reports.map(r => parseFloat(r.total_revenue)));
            const chartHTML = reports.slice(0, 20).map(row => {
                const percentage = (parseFloat(row.total_revenue) / maxRevenue) * 100;
                let periodLabel = row.period;
                
                if (period === 'week') {
                    periodLabel = `W${row.period}`;
                } else if (period === 'month') {
                    periodLabel = row.period;
                } else if (period === 'year') {
                    periodLabel = row.period;
                } else {
                    periodLabel = formatDate(row.period);
                }
                
                return `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">${periodLabel}</span>
                            <span class="text-sm font-bold text-primary">Rp ${parseFloat(row.total_revenue).toLocaleString('id-ID')}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6 relative overflow-hidden">
                            <div class="bg-gradient-to-r from-primary to-accent h-6 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ${percentage}%">
                                <span class="text-xs text-white font-semibold">${row.total_orders} order</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('sales-chart').innerHTML = chartHTML;
        }
        
        function renderTopProducts(products) {
            if (products.length > 0) {
                document.getElementById('top-products-container').classList.remove('hidden');
                const tableBody = document.getElementById('top-products-body');
                tableBody.innerHTML = products.map((product, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-gradient-to-br from-yellow-400 to-yellow-600 text-white' : 'bg-gray-200 text-gray-700'} font-bold text-sm">
                                ${index + 1}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-left font-semibold">${product.nama_produk}</td>
                        <td class="px-4 py-3 text-right font-semibold">${product.total_quantity} pcs</td>
                        <td class="px-4 py-3 text-right font-semibold text-green-600">Rp ${parseFloat(product.total_revenue).toLocaleString('id-ID')}</td>
                        <td class="px-4 py-3 text-right">${product.order_count} order</td>
                    </tr>
                `).join('');
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function formatMonth(monthString) {
            const [year, month] = monthString.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
        }
        
        // Initialize
        toggleCustomDateInputs();
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
        });
    </script>
</body>
</html>
